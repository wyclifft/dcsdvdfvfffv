<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Offline-capable milk collection management system">
  <meta name="theme-color" content="#10b981">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Milk Collect">
  <title>Milk Collection App</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen" class="screen">
    <div class="card">
      <h2>ü•õ Milk Collection</h2>
      <input type="text" id="userid" placeholder="User ID">
      <input type="password" id="password" placeholder="Password">
      <button onclick="login()" class="btn-primary">Login</button>
    </div>
  </div>

  <!-- App Screen -->
  <div id="app-screen" class="screen" style="display:none;">
    <!-- Header -->
    <header>
      <button id="menu-btn" class="menu-btn">‚ò∞</button>
      <h1>Milk Collection</h1>
      <button onclick="logout()" class="btn-logout">Logout</button>
    </header>

    <!-- Sidebar Menu -->
    <nav id="sidebar" class="sidebar">
      <button class="close-btn" onclick="toggleMenu()">‚úï</button>
      <a href="#farmer-card" onclick="toggleMenu()">üë§ Farmer</a>
      <a href="#weight-card" onclick="toggleMenu()">‚öñÔ∏è Weight</a>
      <a href="#receipts-card" onclick="toggleMenu()">üìã Receipts</a>
    </nav>

    <div class="container">
      <div id="user-info" class="user-info"></div>

      <!-- Farmer Card -->
      <div id="farmer-card" class="card">
        <h3>üë§ Farmer Details</h3>
        <div class="autocomplete-wrapper">
          <input type="text" id="farmer-search" placeholder="Search Farmer (ID or Name)" autocomplete="off">
          <div id="farmer-suggestions" class="suggestions-dropdown"></div>
        </div>
        <input type="text" id="farmer-id" placeholder="Farmer ID" readonly>
        <input type="text" id="farmer-name-display" placeholder="Farmer Name" readonly>
        <input type="text" id="route" placeholder="Route" readonly>
        <select id="section">
          <option value="">Select Section</option>
          <option value="AM">AM (Morning)</option>
          <option value="PM">PM (Evening)</option>
        </select>
      </div>

      <!-- Weight Card -->
      <div id="weight-card" class="card">
        <h3>‚öñÔ∏è Milk Weight</h3>
        <div class="weight-section">
          <p id="weight-display" class="weight-display">Weight: 0 Kg</p>
          <button id="connect-scale-btn" onclick="connectScale()" class="btn-primary">Connect Bluetooth Scale</button>
          <p id="scale-status" class="scale-status">Scale: Not Connected</p>
        </div>
        <div class="manual-weight">
          <input type="number" id="manual-weight" placeholder="Manual Weight (Kg)" step="0.1">
          <button onclick="useManualWeight()" class="btn-secondary">Use Manual</button>
        </div>
        <input type="number" id="price-per-liter" placeholder="Price per Liter (Ksh)" step="0.01" value="50">
        <p id="total-amount" class="total-amount">Total: 0 Ksh</p>
        <button onclick="saveMilk()" class="btn-primary">Save Collection</button>
      </div>

      <!-- Receipts Card -->
      <div id="receipts-card" class="card">
        <h3>üìã Pending Receipts</h3>
        <ul id="pending-list" class="pending-list"></ul>
        <div class="button-group">
          <button onclick="syncPendingMilk()" class="btn-secondary">Sync Now</button>
          <button onclick="generateTextReport()" class="btn-secondary">Export TXT</button>
          <button onclick="generateCSVReport()" class="btn-secondary">Export CSV</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Receipt Modal -->
  <div id="modal-backdrop" class="modal-backdrop"></div>
  <div id="receipt-modal" class="receipt-modal hidden">
    <div class="receipt-content">
      <h2>üßæ Receipt</h2>
      <table id="receipt-items"></table>
      <div class="receipt-footer">
        <p>Subtotal: <span id="receipt-subtotal">0</span></p>
        <p><strong>Total: <span id="receipt-total">0</span></strong></p>
      </div>
      <div class="modal-actions">
        <button id="print-receipt-btn" class="btn-primary">Print</button>
        <button id="close-receipt-btn" class="btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="script.js"></script>
  <script src="farmer-autocomplete.js"></script>
  <script src="file-generator.js"></script>
  <script src="script-mobile.js"></script>
  <script>
    document.getElementById('menu-btn').addEventListener('click', toggleMenu);
    function toggleMenu() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    if (isMobile && typeof connectScaleMobile === 'function') {
      const btn = document.getElementById('connect-scale-btn');
      if (btn) {
        btn.onclick = connectScaleMobile;
      }
    }

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('Service Worker registered ‚úÖ'))
          .catch(err => console.error('Service Worker registration failed:', err));
      });
    }
  </script>
</body>
</html>
